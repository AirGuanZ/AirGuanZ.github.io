<!DOCTYPE html>
<html lang="en"><head><title>makefile中的依赖生成</title><meta charset="utf-8"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM Plex Mono&amp;family=Schibsted Grotesk:wght@400;700&amp;family=Source Sans Pro:ital,wght@0,400;0,600;1,400;1,600&amp;display=swap"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta property="og:title" content="makefile中的依赖生成"/><meta property="og:description" content="不正确的makefile 今天在改善我的玩具 Parser Generator AGZParserGen 的时候，我修改了一个头文件，然而当我敲下make的时候，它竟然告诉我目标已经是最新了。显而易见，这是写makefile的时候文件间的依赖关系出了问题。我不禁惊出一身冷汗来，因为在过去相当长的一段时间内，我都是使用同样的方式来自动生成文件依赖。以某个简单的C++项目为例： ..."/><meta property="og:image" content="https://quartz.jzhao.xyz/static/og-image.png"/><meta property="og:width" content="1200"/><meta property="og:height" content="675"/><link rel="icon" href="../../static/icon.png"/><meta name="description" content="不正确的makefile 今天在改善我的玩具 Parser Generator AGZParserGen 的时候，我修改了一个头文件，然而当我敲下make的时候，它竟然告诉我目标已经是最新了。显而易见，这是写makefile的时候文件间的依赖关系出了问题。我不禁惊出一身冷汗来，因为在过去相当长的一段时间内，我都是使用同样的方式来自动生成文件依赖。以某个简单的C++项目为例： ..."/><meta name="generator" content="Quartz"/><link href="../../index.css" rel="stylesheet" type="text/css" spa-preserve/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" rel="stylesheet" type="text/css" spa-preserve/><link href="data:text/css;base64,Ym9keSAua2F0ZXggeyBmb250LXNpemU6IDEwMCU7IG1hcmdpbjogMHB4IDJweDsgfQ0K" rel="stylesheet" type="text/css" spa-preserve/><script src="../../prescript.js" type="application/javascript" spa-preserve></script><script type="application/javascript" spa-preserve>const fetchData = fetch("../../static/contentIndex.json").then(data => data.json())</script></head><body data-slug="旧文归档/2018/2018.04.27.Makefile-Dependency"><div id="quartz-root" class="page"><div id="quartz-body"><div class="left sidebar"><h1 class="page-title"><a href="../..">Automorphism</a></h1><div class="spacer mobile-only"></div><div class="search"><div id="search-icon"><p>Search</p><div></div><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search</title><desc id="desc">Search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"></path><circle cx="8" cy="8" r="7"></circle></g></svg></div><div id="search-container"><div id="search-space"><input autocomplete="off" id="search-bar" name="search" type="text" aria-label="Search for something" placeholder="Search for something"/><div id="search-layout" data-preview="true"></div></div></div></div><div class="darkmode"><input class="toggle" id="darkmode-toggle" type="checkbox" tabindex="-1"/><label id="toggle-label-light" for="darkmode-toggle" tabindex="-1"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="dayIcon" x="0px" y="0px" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35" xml:space="preserve"><title>Dark mode</title><path d="M6,17.5C6,16.672,5.328,16,4.5,16h-3C0.672,16,0,16.672,0,17.5    S0.672,19,1.5,19h3C5.328,19,6,18.328,6,17.5z M7.5,26c-0.414,0-0.789,0.168-1.061,0.439l-2,2C4.168,28.711,4,29.086,4,29.5    C4,30.328,4.671,31,5.5,31c0.414,0,0.789-0.168,1.06-0.44l2-2C8.832,28.289,9,27.914,9,27.5C9,26.672,8.329,26,7.5,26z M17.5,6    C18.329,6,19,5.328,19,4.5v-3C19,0.672,18.329,0,17.5,0S16,0.672,16,1.5v3C16,5.328,16.671,6,17.5,6z M27.5,9    c0.414,0,0.789-0.168,1.06-0.439l2-2C30.832,6.289,31,5.914,31,5.5C31,4.672,30.329,4,29.5,4c-0.414,0-0.789,0.168-1.061,0.44    l-2,2C26.168,6.711,26,7.086,26,7.5C26,8.328,26.671,9,27.5,9z M6.439,8.561C6.711,8.832,7.086,9,7.5,9C8.328,9,9,8.328,9,7.5    c0-0.414-0.168-0.789-0.439-1.061l-2-2C6.289,4.168,5.914,4,5.5,4C4.672,4,4,4.672,4,5.5c0,0.414,0.168,0.789,0.439,1.06    L6.439,8.561z M33.5,16h-3c-0.828,0-1.5,0.672-1.5,1.5s0.672,1.5,1.5,1.5h3c0.828,0,1.5-0.672,1.5-1.5S34.328,16,33.5,16z     M28.561,26.439C28.289,26.168,27.914,26,27.5,26c-0.828,0-1.5,0.672-1.5,1.5c0,0.414,0.168,0.789,0.439,1.06l2,2    C28.711,30.832,29.086,31,29.5,31c0.828,0,1.5-0.672,1.5-1.5c0-0.414-0.168-0.789-0.439-1.061L28.561,26.439z M17.5,29    c-0.829,0-1.5,0.672-1.5,1.5v3c0,0.828,0.671,1.5,1.5,1.5s1.5-0.672,1.5-1.5v-3C19,29.672,18.329,29,17.5,29z M17.5,7    C11.71,7,7,11.71,7,17.5S11.71,28,17.5,28S28,23.29,28,17.5S23.29,7,17.5,7z M17.5,25c-4.136,0-7.5-3.364-7.5-7.5    c0-4.136,3.364-7.5,7.5-7.5c4.136,0,7.5,3.364,7.5,7.5C25,21.636,21.636,25,17.5,25z"></path></svg></label><label id="toggle-label-dark" for="darkmode-toggle" tabindex="-1"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="nightIcon" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100" xml:space="preserve"><title>Light mode</title><path d="M96.76,66.458c-0.853-0.852-2.15-1.064-3.23-0.534c-6.063,2.991-12.858,4.571-19.655,4.571  C62.022,70.495,50.88,65.88,42.5,57.5C29.043,44.043,25.658,23.536,34.076,6.47c0.532-1.08,0.318-2.379-0.534-3.23  c-0.851-0.852-2.15-1.064-3.23-0.534c-4.918,2.427-9.375,5.619-13.246,9.491c-9.447,9.447-14.65,22.008-14.65,35.369  c0,13.36,5.203,25.921,14.65,35.368s22.008,14.65,35.368,14.65c13.361,0,25.921-5.203,35.369-14.65  c3.872-3.871,7.064-8.328,9.491-13.246C97.826,68.608,97.611,67.309,96.76,66.458z"></path></svg></label></div><div class="explorer desktop-only"><button type="button" id="explorer" data-behavior="collapse" data-collapsed="collapsed" data-savestate="true" data-tree="[{&quot;path&quot;:&quot;2024&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;旧文归档&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;旧文归档/2018&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;旧文归档/2019&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;旧文归档/2020&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;旧文归档/2021&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;旧文归档/2022&quot;,&quot;collapsed&quot;:true}]"><h1>Explorer</h1><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="fold"><polyline points="6 9 12 15 18 9"></polyline></svg></button><div id="explorer-content"><ul class="overflow" id="explorer-ul"><li><div class="folder-outer open"><ul style="padding-left:0;" class="content" data-folderul><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="2024"><button class="folder-button"><span class="folder-title">2024</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="2024"><li><a href="../../2024/2024.02.23.VDM-Baking" data-for="2024/2024.02.23.VDM-Baking">[02.23] Vector Displacement Map生成二三事</a></li><li><a href="../../2024/2024.04.13.Fast-Marching-Methods" data-for="2024/2024.04.13.Fast-Marching-Methods">[04.13] Fast Marching Methods</a></li><li><a href="../../2024/2024.04.17.Differential-Forms" data-for="2024/2024.04.17.Differential-Forms">[04.17] Differential Forms</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="旧文归档"><button class="folder-button"><span class="folder-title">旧文归档</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="旧文归档"><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="旧文归档/2018"><button class="folder-button"><span class="folder-title">2018</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="旧文归档/2018"><li><a href="../../旧文归档/2018/2018.04.05.C99-Inline-Keyword" data-for="旧文归档/2018/2018.04.05.C99-Inline-Keyword">[04.05] C99 inline关键字</a></li><li><a href="../../旧文归档/2018/2018.04.27.Makefile-Dependency" data-for="旧文归档/2018/2018.04.27.Makefile-Dependency">[04.27] makefile中的依赖生成</a></li><li><a href="../../旧文归档/2018/2018.06.23.CompGeoNote" data-for="旧文归档/2018/2018.06.23.CompGeoNote">[06.23] 计算几何读书笔记</a></li><li><a href="../../旧文归档/2018/2018.07.13.Cpp-Sucks" data-for="旧文归档/2018/2018.07.13.Cpp-Sucks">[07.13] 为什么要学Rust</a></li><li><a href="../../旧文归档/2018/2018.08.14.Coherence-and-Consistency" data-for="旧文归档/2018/2018.08.14.Coherence-and-Consistency">[08.14] 缓存/内存一致性</a></li><li><a href="../../旧文归档/2018/2018.08.16.AGI-Capter-4" data-for="旧文归档/2018/2018.08.16.AGI-Capter-4">[08.16] 光照传输杂项</a></li><li><a href="../../旧文归档/2018/2018.08.20.Monte-Carlo-Integration-Review" data-for="旧文归档/2018/2018.08.20.Monte-Carlo-Integration-Review">[08.20] 蒙特卡洛积分入门</a></li><li><a href="../../旧文归档/2018/2018.08.27.WC" data-for="旧文归档/2018/2018.08.27.WC">[08.27] 抄书</a></li><li><a href="../../旧文归档/2018/2018.09.04.Quaternion" data-for="旧文归档/2018/2018.09.04.Quaternion">[09.04] 四元数基础</a></li><li><a href="../../旧文归档/2018/2018.09.11.Weingarten-Equations" data-for="旧文归档/2018/2018.09.11.Weingarten-Equations">[09.11] Weingarten Equations</a></li><li><a href="../../旧文归档/2018/2018.10.12.Direct-Indirect-Path-Tracing" data-for="旧文归档/2018/2018.10.12.Direct-Indirect-Path-Tracing">[10.12] 路径追踪中的直接光照</a></li><li><a href="../../旧文归档/2018/2018.10.15.Multiple-Importance-Sampling" data-for="旧文归档/2018/2018.10.15.Multiple-Importance-Sampling">[10.15] 多重重要性采样</a></li><li><a href="../../旧文归档/2018/2018.10.22.Reflection-Models" data-for="旧文归档/2018/2018.10.22.Reflection-Models">[10.22] 物理材质模型</a></li><li><a href="../../旧文归档/2018/2018.10.28.LTE-with-Participating-Medium" data-for="旧文归档/2018/2018.10.28.LTE-with-Participating-Medium">[10.28] 介质渲染</a></li><li><a href="../../旧文归档/2018/2018.10.31.Tagged-Union-in-C++" data-for="旧文归档/2018/2018.10.31.Tagged-Union-in-C++">[10.31] C++中的Tagged Union</a></li><li><a href="../../旧文归档/2018/2018.11.13.BDPT" data-for="旧文归档/2018/2018.11.13.BDPT">[11.13] 双向路径追踪</a></li><li><a href="../../旧文归档/2018/2018.11.17.Delta-Geometry-Factor" data-for="旧文归档/2018/2018.11.17.Delta-Geometry-Factor">[11.17] delta函数积分换元</a></li><li><a href="../../旧文归档/2018/2018.11.20.SH-PRT" data-for="旧文归档/2018/2018.11.20.SH-PRT">[11.20] 基于球谐函数的预计算辐射传输</a></li><li><a href="../../旧文归档/2018/2018.12.02.Camera-Models" data-for="旧文归档/2018/2018.12.02.Camera-Models">[12.02] 摄像机模型小结</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="旧文归档/2019"><button class="folder-button"><span class="folder-title">2019</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="旧文归档/2019"><li><a href="../../旧文归档/2019/2019.02.20.Disney-BRDF" data-for="旧文归档/2019/2019.02.20.Disney-BRDF">[02.20] Disney Principled BRDF实现笔记</a></li><li><a href="../../旧文归档/2019/2019.03.18.White-Furnace-Test" data-for="旧文归档/2019/2019.03.18.White-Furnace-Test">[03.18] White Furnace Test</a></li><li><a href="../../旧文归档/2019/2019.07.10.Light-Tracing" data-for="旧文归档/2019/2019.07.10.Light-Tracing">[07.10] Light Tracing：算法概述和实现</a></li><li><a href="../../旧文归档/2019/2019.07.26.Breakfast-Room" data-for="旧文归档/2019/2019.07.26.Breakfast-Room">[07.10] Breakfast Room</a></li><li><a href="../../旧文归档/2019/2019.11.20.Float-to-Int-Exact-Range" data-for="旧文归档/2019/2019.11.20.Float-to-Int-Exact-Range">[11.20] 可用浮点数精确表示的整数范围</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="旧文归档/2020"><button class="folder-button"><span class="folder-title">2020</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="旧文归档/2020"><li><a href="../../旧文归档/2020/2020.02.02.An-Interesting-Bug" data-for="旧文归档/2020/2020.02.02.An-Interesting-Bug">[02.02] C++中的一个由析构顺序引发的bug</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="旧文归档/2021"><button class="folder-button"><span class="folder-title">2021</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="旧文归档/2021"><li><a href="../../旧文归档/2021/2021.05.013.Mod-Operator" data-for="旧文归档/2021/2021.05.013.Mod-Operator">[05.13] 取模运算</a></li><li><a href="../../旧文归档/2021/2021.06.011.Atmosphere-Rendering" data-for="旧文归档/2021/2021.06.011.Atmosphere-Rendering">[06.11] 预计算大气散射模型：原理与实现</a></li><li><a href="../../旧文归档/2021/2021.06.28.SDF-Gen" data-for="旧文归档/2021/2021.06.28.SDF-Gen">[06.28] 符号距离场生成</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="旧文归档/2022"><button class="folder-button"><span class="folder-title">2022</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="旧文归档/2022"><li><a href="../../旧文归档/2022/2022.04.03.LPM" data-for="旧文归档/2022/2022.04.03.LPM">[04.03] Lightweight Photon Mapping</a></li><li><a href="../../旧文归档/2022/2022.05.28.DX-Matrix-Storage" data-for="旧文归档/2022/2022.05.28.DX-Matrix-Storage">[05.28] 关于HLSL中的矩阵传参</a></li><li><a href="../../旧文归档/2022/2023.07.02.Statically-Get-Class-Type" data-for="旧文归档/2022/2023.07.02.Statically-Get-Class-Type">[07.02] 在C++中获得当前类的类型</a></li></ul></div></li></ul></div></li><li><div class="folder-outer "><ul style="padding-left:0;" class="content" data-folderul></ul></div></li></ul></div></li><li id="explorer-end"></li></ul></div></div></div><div class="center"><div class="page-header"><div class="popover-hint"><nav class="breadcrumb-container" aria-label="breadcrumbs"><div class="breadcrumb-element"><a href="../../">Home</a><p> ❯ </p></div><div class="breadcrumb-element"><a href="../../旧文归档/">旧文归档</a><p> ❯ </p></div><div class="breadcrumb-element"><a href="../../旧文归档/2018/">2018</a><p> ❯ </p></div><div class="breadcrumb-element"><a href>makefile中的依赖生成</a></div></nav><h1 class="article-title">makefile中的依赖生成</h1><p show-comma="true" class="content-meta"><span>Apr 27, 2018</span><span>8 min read</span></p><ul class="tags"><li><a href="../../tags/makefile" class="internal tag-link">makefile</a></li></ul></div></div><article class="popover-hint"><h2 id="不正确的makefile">不正确的makefile<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#不正确的makefile" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>今天在改善我的玩具 Parser Generator <a href="https://github.com/AirGuanZ/AGZParserGen" class="external">AGZParserGen<svg class="external-icon" viewBox="0 0 512 512"><path d="M320 0H288V64h32 82.7L201.4 265.4 178.7 288 224 333.3l22.6-22.6L448 109.3V192v32h64V192 32 0H480 320zM32 32H0V64 480v32H32 456h32V480 352 320H424v32 96H64V96h96 32V32H160 32z"></path></svg></a> 的时候，我修改了一个头文件，然而当我敲下<code>make</code>的时候，它竟然告诉我目标已经是最新了。显而易见，这是写makefile的时候文件间的依赖关系出了问题。我不禁惊出一身冷汗来，因为在过去相当长的一段时间内，我都是使用同样的方式来自动生成文件依赖。以某个简单的C++项目为例：</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="makefile" data-theme="github-light github-dark"><code data-language="makefile" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CC = clang++</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CC_INCLUDE_FLAGS = -I ./Include/</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CC_FLAGS = -std=c++11 -O2 </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CC_INCLUDE_FLAGS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -Werror -Wall</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CPP_SRC_FILES = </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">shell</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> find ./Source/ -name &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.cpp&quot;)</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CPP_OBJ_FILES = </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">patsubst</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> %</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.cpp, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.o, $(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CPP_SRC_FILES</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">))</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CPP_DPT_FILES = </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">patsubst</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> %</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.cpp, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.d, $(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CPP_SRC_FILES</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">))</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DST = Output</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DST</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CPP_OBJ_FILES</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	$(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CC</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $^</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -o </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$@</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.o</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.cpp</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	$(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CC</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> $(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CC_FLAGS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -c </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -o </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$@</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.d</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.cpp</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	@</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">set -e; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	rm -f </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$@</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	$(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CC</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -MM </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CC_FLAGS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> $&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> $(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CC_INCLUDE_FLAGS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> > </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$@</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$$$$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.dtmp; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	sed 's,\(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">\)\.o[ :]*,\1.o </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$@</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : ,g' &lt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$@</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$$$$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.dtmp > </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$@</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	rm -f </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$@</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$$$$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.dtmp</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> $(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CPP_DPT_FILES</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">clean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	rm -f </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DST</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	rm -f </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CPP_OBJ_FILES</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	rm -f </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CPP_DPT_FILES</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	rm -f </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">shell</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> find ./Source/ -name &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.dtmp&quot;)</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	make</span></span>
<span data-line><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	$(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DST</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span></span></code></pre></figure>
<p>这里面隐藏了一个致命的错误，我很好奇为什么我以前都没有踩到这个大坑，但既然今天被我发现了，自然要拖出来批判一番。</p>
<p>文件思路很简单，用<code>shell find</code>找到代码目录下所有的<code>.cpp</code>文件名（<code>CPP_SRC_FILES</code>），并通过后缀替换得到对应的<code>.o</code>文件名（<code>CPP_OBJ_FILES</code>）和<code>.d</code>文件名（<code>CPP_DPT_FILES</code>）。目标文件依赖于所有的<code>.o</code>，每个<code>.o</code>又依赖于自己的<code>.cpp</code>。</p>
<p>当然，<code>.o</code>仅仅依赖于<code>.cpp</code>是不够的，还应该依赖于该<code>.cpp</code>中包含以及间接包含的所有文件。这一依赖关系就存放在<code>.d</code>文件中，且这些<code>.d</code>在第24行被引入该makefile中。那么<code>.d</code>文件有何来头呢？它们是第17~22行代码生成的，而这几行代码我是从网上直接抄的（数个博客中都是这一段代码，我真是日了哈士奇了），它就是导致依赖关系不正确的万恶之源。下面逐行地解析这段有问题的的代码。</p>
<pre><code>%.d: %.cpp
	@set -e; \
	rm -f $@; \
	$(CC) -MM $(CC_FLAGS) $&lt; $(CC_INCLUDE_FLAGS) > $@.$$$$.dtmp; \
	sed 's,\($*\)\.o[ :]*,\1.o $@ : ,g' &lt; $@.$$$$.dtmp > $@; \
	rm -f $@.$$$$.dtmp
</code></pre>
<p>第一行<code>%.d: %.cpp</code>是makefile的语法，意思是形如“%.d”的文件依赖于一个名为“%.cpp”的文件，这个没什么好说的。</p>
<p>第二行<code>@set -e;</code>的含义是一旦出现错误，立即放弃执行后续的命令。加上这行是为了保证我看得到生成<code>.d</code>时的错误消息，而不是被后面一连串命令的输出掩盖。</p>
<p>第三行<code>rm -f $@;</code>是删除已经存在的<code>.d</code>文件，其中<code>$@</code>是makefile的特殊语法，表示要生成的目标文件。</p>
<p>第四个命令使用了gcc/clang都支持的一个特殊功能——加上<code>-MM</code>参数表示将源文件包含以及间接包含的文件（标准库除外）以依赖项的形式输出到标准输出流。这行命令末尾把编译器的输出重定向到一个<code>.dtmp</code>的文件中，其中<code>$@</code>是目标文件名，四个美元符表示当前进程号。<code>.dtmp</code>文件只是一个临时文件，稍后会被自动删除。</p>
<p>第五个命令调用了<code>sed</code>，它是一个灵活的字符串操作工具，在这里用来将<code>.d</code>文件的依赖项插入到依赖文件内容中，并输出为需要的<code>.d</code>。这么说不太清晰，稍后举例即可看到。</p>
<p>最后一个命令删除了之前临时存放依赖关系的文件。至此，<code>.d</code>文件的生成就大功告成了。</p>
<p>举个简单的例子，我们在某个空目录下创建一个<code>src</code>目录，在其中放置<code>a.cpp</code>，<code>a.h</code>和<code>b.h</code>三个文件，它们包含如下内容：</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="cpp" data-theme="github-light github-dark"><code data-language="cpp" data-theme="github-light github-dark" style="display:grid;"><span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* In a.h */</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;b.h&quot;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* In b.h */</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;iostream></span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* In a.cpp */</span></span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;a.h&quot;</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span data-line> </span>
<span data-line><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></figure>
<p>现在要把<code>src/a.cpp</code>编译为<code>src/a.o</code>，我们期望的依赖是<code>src/a.o src/a.d: src/a.cpp src/a.h src/b.h</code>。假设我们使用上述的makefile来构建这个“项目”，那么clang++输出的临时文件会是：</p>
<pre><code>a.o: src/a.cpp src/a.h src/b.h
</code></pre>
<p>这一输出和我们期望的输出有两个差异，一个是该输出不包含<code>.d</code>文件的依赖关系，第五个命令中的<code>sed</code>就是用来添加这个关系的；另一个差异则是目标文件名——<code>a.o</code>和<code>src/a.o</code>完全不是一回事！很不幸，第二个差异是致命的，它不仅导致这个依赖关系无效（<code>a.o</code>根本不在<code>$(DST)</code>的依赖列表中），还导致<code>sed</code>命令无法查找到<code>src/a.o</code>进而无法添加<code>.d</code>文件的依赖关系。可以说，这样的依赖关系生成方案只能应对所有的<code>.cpp</code>都和makefile在同一个目录下的情况，一旦某个<code>.cpp</code>在别的目录下（比如这里的<code>src/a.cpp</code>），就会无法生成正确的依赖文件。</p>
<p>说到这我就来气，网络上这么多博主都在博文中如是构建依赖关系，大部分人恐怕都只是你抄我我抄你罢了……</p>
<h2 id="错误修正">错误修正<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#错误修正" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>要修复这个问题也很简单，那就是修改<code>sed</code>命令的参数，让它把这两个差异都处理掉。修改后的第五个命令如下：</p>
<pre><code>sed 's,\(.*\)\.o\:,$*\.o $*\.d\:,g' &lt; $@.$$$$.dtmp > $@;
</code></pre>
<p>其中，<code>\(.*\)\.o\:</code>会匹配形如<code>a.o:</code>这样的字符串，并将其替换为路径正确的<code>.o</code>和<code>.d</code>文件名以及其后的<code>:</code>。这里<code>$*</code>是makefile的特殊语法，表示的是<code>%.d</code>中“<code>%</code>”所代表的字符串（即去掉了后缀的文件路径）。这一行命令能够正确地将clang++输出的</p>
<pre><code>a.o: src/a.cpp src/a.h src/b.h
</code></pre>
<p>替换为</p>
<pre><code>src/a.o src/a.d: src/a.cpp src/a.h src/b.h
</code></pre></article></div><div class="right sidebar"><div class="toc desktop-only"><button type="button" id="toc" class><h3>Table of Contents</h3><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="fold"><polyline points="6 9 12 15 18 9"></polyline></svg></button><div id="toc-content"><ul class="overflow"><li class="depth-0"><a href="#不正确的makefile" data-for="不正确的makefile">不正确的makefile</a></li><li class="depth-0"><a href="#错误修正" data-for="错误修正">错误修正</a></li></ul></div></div><div class="backlinks"><h3>Backlinks</h3><ul class="overflow"><li><a href="../../" class="internal">Automorphism</a></li></ul></div></div></div><footer class><hr/><p>Created with <a href="https://quartz.jzhao.xyz/">Quartz v4.2.3</a> © 2024</p><ul><li><a href="https://github.com/jackyzha0/quartz">GitHub</a></li><li><a href="https://discord.gg/cRFFHYye7t">Discord Community</a></li></ul></footer></div></body><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/copy-tex.min.js" type="application/javascript"></script><script type="application/javascript">function c(){let t=this.parentElement;t.classList.toggle("is-collapsed");let l=t.classList.contains("is-collapsed")?this.scrollHeight:t.scrollHeight;t.style.maxHeight=l+"px";let o=t,e=t.parentElement;for(;e;){if(!e.classList.contains("callout"))return;let n=e.classList.contains("is-collapsed")?e.scrollHeight:e.scrollHeight+o.scrollHeight;e.style.maxHeight=n+"px",o=e,e=e.parentElement}}function i(){let t=document.getElementsByClassName("callout is-collapsible");for(let s of t){let l=s.firstElementChild;if(l){l.addEventListener("click",c),window.addCleanup(()=>l.removeEventListener("click",c));let e=s.classList.contains("is-collapsed")?l.scrollHeight:s.scrollHeight;s.style.maxHeight=e+"px"}}}document.addEventListener("nav",i);window.addEventListener("resize",i);
</script><script type="module">
          let mermaidImport = undefined
          document.addEventListener('nav', async () => {
            if (document.querySelector("code.mermaid")) {
              mermaidImport ||= await import('https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.7.0/mermaid.esm.min.mjs')
              const mermaid = mermaidImport.default
              const darkMode = document.documentElement.getAttribute('saved-theme') === 'dark'
              mermaid.initialize({
                startOnLoad: false,
                securityLevel: 'loose',
                theme: darkMode ? 'dark' : 'default'
              })

              await mermaid.run({
                querySelector: '.mermaid'
              })
            }
          });
          </script><script type="application/javascript">
            const socket = new WebSocket('ws://localhost:3001')
            // reload(true) ensures resources like images and scripts are fetched again in firefox
            socket.addEventListener('message', () => document.location.reload(true))
          </script><script src="../../postscript.js" type="module"></script></html>